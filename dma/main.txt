/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Rohit Nimkar <nehalnimkar@gmail.com> <https://csrohit.github.io>
 * @brief          : Main program body
 ******************************************************************************
 */

#include <stm32f1xx.h>
#include <uart.h>
void SysTick_Handler(void);
void delay(int ms);


volatile uint32_t msTicks = 0;

/**
 * @brief Interrupt handler function
 * 
 */
void SysTick_Handler(void)
{
	msTicks++;
}

/**
 * @brief Add blocking delay
 *
 * @param ms delay in milliseconds
 */
void delay(int ms)
{
	uint32_t expected_ticks = msTicks + ms;
	while (msTicks < expected_ticks)
	{
		__asm("nop");
	}
}

const char * msg = "Hello world\n\r\0";


int main(void)
{
	USART1_init(9600U);
	SysTick_Config(SystemCoreClock/1000);
	RCC->APB2ENR |= RCC_APB2ENR_IOPCEN;
	GPIOC->CRH = 0x02 << ((13 - 8) << 2);
	while(1){
		GPIOC->ODR ^= 1 << 13;
		USART1_puts(msg);
		delay(5000U);
	}
}
